<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teklif Detayƒ± #{{ offer.id }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left { display: flex; align-items: center; }
        .header h1 { color: #333; font-size: 24px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .revision-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-warning { background: #ffc107; color: #333; font-weight: 600; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }

        /* Status Banner */
        .status-banner {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-banner.draft { border-left: 5px solid #6c757d; }
        .status-banner.sent { border-left: 5px solid #ffc107; }
        .status-banner.approved { border-left: 5px solid #28a745; }
        .status-banner.rejected { border-left: 5px solid #dc3545; }
        .status-banner.revised { border-left: 5px solid #17a2b8; }

        .status-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .status-label { font-size: 14px; color: #666; }
        .status-value { font-size: 20px; font-weight: bold; }

        .status-draft { color: #6c757d; }
        .status-sent { color: #856404; }
        .status-approved { color: #28a745; }
        .status-rejected { color: #dc3545; }
        .status-revised { color: #17a2b8; }

        .reject-reason {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
        }
        .reject-reason strong { color: #856404; }

        /* Personel Card */
        .personel-card {
            background: white;
            padding: 22px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .personel-item label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .person-tag {
            display: inline-flex;
            align-items: center;
            gap: 9px;
            padding: 6px 12px;
            border-radius: 20px;
            margin-top: 6px;
        }
        .person-tag.firma { background: #eef1ff; }
        .person-tag.approve { background: #eafff2; }
        .person-tag.reject { background: #fff0f0; }

        .person-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .avatar-firma { background: #667eea; }
        .avatar-approve { background: #28a745; }
        .avatar-reject { background: #dc3545; }

        .person-name { font-size: 14px; font-weight: 600; color: #333; }
        .person-role { font-size: 11px; color: #888; }

        /* Fatura B√∂l√ºm√º (read-only) */
        .invoice-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .invoice-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 16px 25px;
            font-size: 17px;
            font-weight: 600;
        }

        .invoice-body { padding: 22px 30px; }

        .invoice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .invoice-item label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invoice-item p {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin-top: 5px;
        }

        .invoice-item .empty-val {
            color: #999;
            font-style: italic;
            font-weight: 400;
            font-size: 14px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card .label { color: #666; font-size: 12px; margin-bottom: 8px; }
        .summary-card .value { font-size: 24px; font-weight: bold; color: #333; }
        .summary-card.total .value { color: #28a745; }
        .summary-card.blue .value { color: #007bff; }

        /* Products Table */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .table-header h2 { font-size: 20px; }

        .products-table { width: 100%; border-collapse: collapse; }
        .products-table thead { background: #f8f9fa; }

        .products-table thead th {
            padding: 13px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        .products-table thead th small { color: #999; font-weight: 400; }

        .products-table tbody tr { border-bottom: 1px solid #f0f0f0; transition: all 0.3s; }
        .products-table tbody tr:hover { background: #f8f9fa; }
        .products-table tbody td { padding: 13px 15px; vertical-align: middle; font-size: 14px; }

        .product-name { font-weight: 600; color: #333; }
        .product-note { color: #666; font-size: 12px; margin-top: 5px; font-style: italic; }
        .price-green { font-weight: bold; color: #28a745; }
        .price-blue { font-size: 12px; color: #007bff; }
        .price-red { color: #dc3545; font-weight: 600; font-size: 12px; }

        .discount-badge {
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 6px;
            color: #856404;
            font-size: 14px;
        }

        /* Totals */
        .totals-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .totals-header { background: #2c3e50; color: white; padding: 15px 25px; font-size: 16px; font-weight: 600; }
        .totals-body { padding: 25px 30px; }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .totals-row:last-child { border-bottom: none; }
        .totals-row label { color: #555; font-size: 15px; }
        .totals-row .amount { font-size: 16px; font-weight: 600; color: #333; }
        .totals-row.discount-row label { color: #dc3545; }
        .totals-row.discount-row .amount { color: #dc3545; }

        .totals-row.final-row {
            background: #f0f7ff;
            margin: 10px -30px -25px -30px;
            padding: 18px 30px;
            border-radius: 0 0 10px 10px;
        }
        .totals-row.final-row label { font-size: 18px; font-weight: 700; color: #2c3e50; }
        .totals-row.final-row .amount { font-size: 24px; color: #28a745; }

        @media (max-width: 768px) {
            .products-table { font-size: 12px; }
            .products-table thead th, .products-table tbody td { padding: 8px; }
            .header { flex-direction: column; align-items: flex-start; }
            .summary-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% include 'includes/navbar.html' %}
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üìÑ Teklif
                    {% if offer.original_offer %}#{{ offer.original_offer.id }}{% else %}#{{ offer.id }}{% endif %}
                    {% if offer.revision_number > 1 %}
                        <span class="revision-badge">üîÑ Rev.{{ offer.revision_number }}</span>
                    {% endif %}
                </h1>
            </div>
            <div class="header-actions">
                {% if offer.original_offer or offer.revisions.exists %}
                <a href="{% url 'view_offer_history' offer.id %}" class="btn btn-secondary">üìú Ge√ßmi≈ü</a>
                {% endif %}
                {% if offer.status == 'rejected' %}
                <a href="{% url 'revise_offer' offer.id %}" class="btn btn-warning">üîÑ Revize Et</a>
                {% endif %}
                <a href="{% url 'export_offer_excel' offer.id %}" class="btn" style="background:#28a745; color:white;">üì• Excel</a>
                <a href="{% url 'export_offer_pdf' offer.id %}" class="btn" style="background:#dc3545; color:white;">üìÑ PDF</a>
                <a href="{% url 'my_offers' %}" class="btn btn-primary">‚Üê Ana Sayfa</a>
            </div>
        </div>

        <!-- Status Banner -->
        <div class="status-banner {{ offer.status }}">
            <div class="status-info">
                <div>
                    <div class="status-label">Teklif Durumu</div>
                    <div class="status-value status-{{ offer.status }}">
                        {% if offer.status == 'draft' %}üìã Taslak
                        {% elif offer.status == 'sent' %}üì¨ Eczaneye G√∂nderildi
                        {% elif offer.status == 'approved' %}‚úÖ Onaylandƒ±
                        {% elif offer.status == 'rejected' %}‚ùå Reddedildi
                        {% elif offer.status == 'revised' %}üîÑ Revize Edildi
                        {% endif %}
                    </div>
                </div>
                {% if offer.sent_at %}
                <div>
                    <div class="status-label">G√∂nderilme Tarihi</div>
                    <div class="status-value" style="font-size:16px;">{{ offer.sent_at|date:"d.m.Y H:i" }}</div>
                </div>
                {% endif %}
                {% if offer.approved_at %}
                <div>
                    <div class="status-label">Onaylanma Tarihi</div>
                    <div class="status-value" style="font-size:16px;">{{ offer.approved_at|date:"d.m.Y H:i" }}</div>
                </div>
                {% endif %}
                {% if offer.rejected_at %}
                <div>
                    <div class="status-label">Reddedilme Tarihi</div>
                    <div class="status-value" style="font-size:16px;">{{ offer.rejected_at|date:"d.m.Y H:i" }}</div>
                </div>
                {% endif %}
            </div>
            {% if offer.reject_reason %}
            <div class="reject-reason">
                <strong>‚ùå Red Nedeni:</strong> {{ offer.reject_reason }}
            </div>
            {% endif %}
        </div>

        <!-- Personel Bilgileri -->
        <div class="personel-card">
            <!-- Teklif Hazƒ±rlayan -->
            <div class="personel-item">
                <label>Teklif Hazƒ±rlayan</label>
                <div class="person-tag firma">
                    <div class="person-avatar avatar-firma">{{ offer.user.first_name|first }}{{ offer.user.last_name|first }}</div>
                    <div>
                        <div class="person-name">{{ offer.user.get_full_name|default:offer.user.username }}</div>
                        <div class="person-role">Firma</div>
                    </div>
                </div>
            </div>

            <!-- Onaylayan -->
            {% if offer.approved_by %}
            <div class="personel-item">
                <label>Onaylayan Personel</label>
                <div class="person-tag approve">
                    <div class="person-avatar avatar-approve">{{ offer.approved_by.first_name|first }}{{ offer.approved_by.last_name|first }}</div>
                    <div>
                        <div class="person-name">{{ offer.approved_by.get_full_name|default:offer.approved_by.username }}</div>
                        <div class="person-role">Eczane</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reddeden -->
            {% if offer.rejected_by %}
            <div class="personel-item">
                <label>Reddeden Personel</label>
                <div class="person-tag reject">
                    <div class="person-avatar avatar-reject">{{ offer.rejected_by.first_name|first }}{{ offer.rejected_by.last_name|first }}</div>
                    <div>
                        <div class="person-name">{{ offer.rejected_by.get_full_name|default:offer.rejected_by.username }}</div>
                        <div class="person-role">Eczane</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Fatura Bilgileri (sadece onaylandƒ± ‚Üí read-only) -->
        {% if offer.status == "approved" %}
        <div class="invoice-section">
            <div class="invoice-header">üìÑ Fatura ve Teslimat Bilgileri</div>
            <div class="invoice-body">
                <div class="invoice-grid">
                    <div class="invoice-item">
                        <label>Fatura No</label>
                        <p>{% if offer.invoice_number %}{{ offer.invoice_number }}{% else %}<span class="empty-val">Hen√ºz girilmedi</span>{% endif %}</p>
                    </div>
                    <div class="invoice-item">
                        <label>Fatura Tarihi</label>
                        <p>{% if offer.invoice_date %}{{ offer.invoice_date|date:"d.m.Y" }}{% else %}<span class="empty-val">Hen√ºz girilmedi</span>{% endif %}</p>
                    </div>
                    <div class="invoice-item">
                        <label>Termin Tarihi</label>
                        <p>{% if offer.delivery_deadline %}{{ offer.delivery_deadline|date:"d.m.Y" }}{% else %}<span class="empty-val">Hen√ºz girilmedi</span>{% endif %}</p>
                    </div>
                </div>
                
                <!-- Teslimat Adresi Se√ßimi Butonu -->
                <div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <a href="{% url 'assign_delivery_addresses' offer.id %}" class="btn btn-primary" style="padding: 12px 30px; font-size: 15px;">
                        üìç Teslimat Adresi Se√ß
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="label">√úr√ºn Sayƒ±sƒ±</div>
                <div class="value">{{ offer.items.count }}</div>
            </div>
            <div class="summary-card blue">
                <div class="label">KDV Hari√ß Toplam</div>
                <div class="value">
                    {% if offer.status == "approved" %}
                        {{ offer.net_after_overall_discount|floatformat:2 }} ‚Ç∫
                    {% else %}
                        {{ offer.items_net_after_item_discounts|floatformat:2 }} ‚Ç∫
                    {% endif %}
                </div>
            </div>
            <div class="summary-card total">
                <div class="label">Toplam (KDV Dahil)</div>
                <div class="value">{{ offer.final_total|floatformat:2 }} ‚Ç∫</div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="table-container">
            <div class="table-header">
                <h2>üì¶ √úr√ºn Listesi</h2>
            </div>

            {% if offer.items.all %}
            <table class="products-table">
                <thead>
                    <tr>
                        <th>√úr√ºn</th>
                        <th>Adet</th>
                        <th>Birim Fiyat<br><small>(KDV Dahil / Hari√ß)</small></th>
                        {% if offer.status == "approved" %}
                        <th>ƒ∞skonto</th>
                        {% endif %}
                        <th>KDV %</th>
                        <th>Ara Toplam<br><small>(KDV Hari√ß)</small></th>
                        <th>KDV Tutarƒ±</th>
                        <th>Toplam<br><small>(KDV Dahil)</small></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in offer.items.all %}
                    <tr>
                        <td>
                            <div class="product-name">{{ item.product.name }}</div>
                            {% if offer.status == "approved" and item.note %}
                            <div class="product-note">üìù Eczane Notu: {{ item.note }}</div>
                            {% endif %}
                            {% if item.delivery_address %}
                            <div class="product-note">üìç {{ item.delivery_address.title }}</div>
                            {% endif %}
                        </td>

                        <td>{{ item.quantity }}</td>

                        <!-- Birim Fiyat -->
                        <td>
                            <span class="price-green">{{ item.unit_price_with_vat|floatformat:2 }} ‚Ç∫</span><br>
                            <span class="price-blue">{{ item.unit_price|floatformat:2 }} ‚Ç∫</span>
                        </td>

                        <!-- ƒ∞skonto (sadece onaylandƒ±) -->
                        {% if offer.status == "approved" %}
                        <td>
                            {% if item.discount_type != 'none' %}
                                <span class="discount-badge">{{ item.get_discount_type_display }} {{ item.discount_value|floatformat:2 }}</span>
                                <div class="price-red" style="margin-top:4px;">-{{ item.discount_amount|floatformat:2 }} ‚Ç∫</div>
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                        {% endif %}

                        <td>{{ item.vat_rate }}%</td>
                        <td>{{ item.line_subtotal|floatformat:2 }} ‚Ç∫</td>
                        <td>{{ item.vat_amount|floatformat:2 }} ‚Ç∫</td>
                        <td><span class="price-green">{{ item.total_price|floatformat:2 }} ‚Ç∫</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if offer.status != "approved" %}
            <div class="info-box">
                <strong>‚ÑπÔ∏è Not:</strong> ƒ∞skonto ve eczane notlarƒ± yalnƒ±zca teklif onaylandƒ±ktan sonra g√∂r√ºnt√ºlenir.
            </div>
            {% endif %}

            {% else %}
            <div style="text-align:center; padding:60px 20px;">
                <div style="font-size:64px; margin-bottom:20px;">üì≠</div>
                <h3 style="color:#333;">Teklifte √ºr√ºn yok</h3>
            </div>
            {% endif %}
        </div>

        <!-- Toplam √ñzeti -->
        <div class="totals-section">
            <div class="totals-header">üìä Toplam √ñzeti</div>
            <div class="totals-body">

                <div class="totals-row">
                    <label>KDV Hari√ß Toplam (ƒ∞skonto √ñncesi)</label>
                    <span class="amount">{{ offer.items_subtotal_net|floatformat:2 }} ‚Ç∫</span>
                </div>

                {% if offer.status == "approved" %}
                    {% if offer.items_subtotal_net != offer.items_net_after_item_discounts %}
                    <div class="totals-row discount-row">
                        <label>√úr√ºn ƒ∞skonto Toplamƒ±</label>
                        <span class="amount">-{{ offer.total_item_discounts|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="totals-row">
                        <label>KDV Hari√ß Toplam (√úr√ºn ƒ∞skontlarƒ± Sonrasƒ±)</label>
                        <span class="amount">{{ offer.items_net_after_item_discounts|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    {% endif %}

                    {% if offer.overall_discount_type != "none" %}
                    <div class="totals-row discount-row">
                        <label>
                            üè∑Ô∏è Genel ƒ∞skonto
                            {% if offer.overall_discount_type == "percent" %}({{ offer.overall_discount_value }}%){% endif %}
                            {% if offer.overall_discount_type == "amount" %}(‚Ç∫){% endif %}
                        </label>
                        <span class="amount">-{{ offer.overall_discount_amount|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="totals-row">
                        <label>Genel ƒ∞skonto Sonrasƒ± KDV Hari√ß</label>
                        <span class="amount">{{ offer.net_after_overall_discount|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    {% endif %}
                {% endif %}

                <div class="totals-row">
                    <label>KDV Toplamƒ±</label>
                    <span class="amount">
                        {% if offer.status == "approved" %}
                            {{ offer.vat_after_overall_discount|floatformat:2 }} ‚Ç∫
                        {% else %}
                            {{ offer.items_vat_after_item_discounts|floatformat:2 }} ‚Ç∫
                        {% endif %}
                    </span>
                </div>

                <div class="totals-row final-row">
                    <label>üí∞ Son Toplam (KDV Dahil)</label>
                    <span class="amount">{{ offer.final_total|floatformat:2 }} ‚Ç∫</span>
                </div>
            </div>
        </div>

    </div>
</body>
</html>